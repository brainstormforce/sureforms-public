"use strict";(self.webpackChunksureforms=self.webpackChunksureforms||[]).push([[730],{8578:function(e,t,n){n.d(t,{o:function(){return o}});var i=n(6046),o=function(e,t,n){void 0===n&&(n=!0);var o="Function"===e.constructor.name?e.prototype:e,r=o.componentWillLoad;o.componentWillLoad=function(){var e,o=this,s=(0,i.g)(this),a={promise:new Promise((function(t){e=t})),resolve:e},d=new CustomEvent("openWormhole",{bubbles:!0,composed:!0,detail:{consumer:this,fields:t,updater:function(e,t){(e in s?s:o)[e]=t},onOpen:a}});s.dispatchEvent(d);var l=function(){if(r)return r.call(o)};return n?a.promise.then((function(){return l()})):l()}}},4920:function(e,t,n){n.d(t,{c:function(){return d},e:function(){return s},f:function(){return l}});var i=n(712),o=n(8517);const r="surecart/v1/orders/",s=["line_items","line_item.price","price.product","customer","customer.shipping_address","payment_intent","discount","discount.promotion","discount.coupon","shipping_address","tax_identifier"],a=(e,t="")=>{let n=e?`${r}${e}`:r;return n=`${n}${t}`,(0,o.a)(n,{expand:s})},d=async({id:e,data:t,query:n={}})=>await(0,i.a)({method:e?"PATCH":"POST",path:(0,o.a)(a(e),n),data:t}),l=async({id:e,data:t={},query:n={},processor:r})=>await(0,i.a)({method:"POST",path:(0,o.a)(a(e,"/finalize/"),{processor_type:r,...n}),data:t})},551:function(e,t,n){n.d(t,{p:function(){return o}});var i=(0,n(5115).c)((function(e,t){function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}Object.defineProperty(t,"__esModule",{value:!0});var i,o="https://js.stripe.com/v3",r=/^https:\/\/js\.stripe\.com\/v3\/?(\?.*)?$/,s="loadStripe.setLoadParameters was called but an existing Stripe.js script already exists in the document; existing script parameters will be used",a=null,d=function(e){return null!==a||(a=new Promise((function(t,n){if("undefined"!=typeof window)if(window.Stripe&&e&&console.warn(s),window.Stripe)t(window.Stripe);else try{var i=function(){for(var e=document.querySelectorAll('script[src^="'.concat(o,'"]')),t=0;t<e.length;t++){var n=e[t];if(r.test(n.src))return n}return null}();i&&e?console.warn(s):i||(i=function(e){var t=e&&!e.advancedFraudSignals?"?advancedFraudSignals=false":"",n=document.createElement("script");n.src="".concat(o).concat(t);var i=document.head||document.body;if(!i)throw new Error("Expected document.body not to be null. Stripe.js requires a <body> element.");return i.appendChild(n),n}(e)),i.addEventListener("load",(function(){window.Stripe?t(window.Stripe):n(new Error("Stripe.js not available"))})),i.addEventListener("error",(function(){n(new Error("Failed to load Stripe.js"))}))}catch(e){return void n(e)}else t(null)}))),a},l=function(e,t,n){if(null===e)return null;var i=e.apply(void 0,t);return function(e,t){e&&e._registerWrapper&&e._registerWrapper({name:"stripe-js",version:"1.28.0",startTime:t})}(i,n),i},u=!1,c=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];u=!0;var o=Date.now();return d(i).then((function(e){return l(e,t,o)}))};c.setLoadParameters=function(e){if(u)throw new Error("You cannot change load parameters after calling loadStripe");i=function(e){var t="invalid load parameters; expected object of shape\n\n    {advancedFraudSignals: boolean}\n\nbut received\n\n    ".concat(JSON.stringify(e),"\n");if(null===e||"object"!==n(e))throw new Error(t);if(1===Object.keys(e).length&&"boolean"==typeof e.advancedFraudSignals)return e;throw new Error(t)}(e)},t.loadStripe=c})),o=i},730:function(e,t,n){n.r(t),n.d(t,{sc_stripe_payment_request:function(){return d}});var i=n(6046),o=n(551),r=n(290),s=n(8578),a=n(4920);n(5115),n(712);const d=class{constructor(e){(0,i.r)(this,e),this.scFormSubmit=(0,i.c)(this,"scFormSubmit",7),this.scPaid=(0,i.c)(this,"scPaid",7),this.scPayError=(0,i.c)(this,"scPayError",7),this.scSetState=(0,i.c)(this,"scSetState",7),this.scPaymentRequestLoaded=(0,i.c)(this,"scPaymentRequestLoaded",7),this.scUpdateOrderState=(0,i.c)(this,"scUpdateOrderState",7),this.country="US",this.currencyCode="usd",this.label="total",this.amount=0,this.theme="dark",this.debug=!1,this.loaded=!1}async componentWillLoad(){if(!(null==this?void 0:this.publishableKey)||!(null==this?void 0:this.stripeAccountId))return!0;this.stripe=await o.p.loadStripe(this.publishableKey,{stripeAccount:this.stripeAccountId}),this.elements=this.stripe.elements(),this.paymentRequest=this.stripe.paymentRequest({country:this.country,requestShipping:!0,requestPayerEmail:!0,shippingOptions:[{id:"free",label:"Free Shipping",detail:"No shipping required",amount:0}],...this.getRequestObject(this.order)})}handleOrderChange(){this.paymentRequest&&(this.pendingEvent||this.paymentRequest.update(this.getRequestObject(this.order)))}handleLoaded(){this.scPaymentRequestLoaded.emit(!0)}handleErrorChange(){this.pendingEvent&&this.pendingEvent.complete("error")}async handleShippingChange(e){var t,n,i,o,s;const{shippingAddress:d,updateWith:l}=e;try{const e=await(0,a.c)({id:null===(t=this.order)||void 0===t?void 0:t.id,data:{shipping_address:{...(null==d?void 0:d.name)?{name:null==d?void 0:d.name}:{},...(null===(n=null==d?void 0:d.addressLine)||void 0===n?void 0:n[0])?{line_1:null===(i=null==d?void 0:d.addressLine)||void 0===i?void 0:i[0]}:{},...(null===(o=null==d?void 0:d.addressLine)||void 0===o?void 0:o[1])?{line_2:null===(s=null==d?void 0:d.addressLine)||void 0===s?void 0:s[1]}:{},...(null==d?void 0:d.city)?{city:null==d?void 0:d.city}:{},...(null==d?void 0:d.country)?{country:null==d?void 0:d.country}:{},...(null==d?void 0:d.postalCode)?{postal_code:null==d?void 0:d.postalCode}:{},...(null==d?void 0:d.region)?{state:null==d?void 0:d.region}:{}}}});l({status:"success",total:{amount:(null==e?void 0:e.amount_due)||0,label:(0,r._)("Total","surecart"),pending:!0}})}catch(e){e.updateWith({status:"invalid_shipping_address"})}}getName(e){var t,n,i,o,r;let s="";return s=Object.keys(this.prices||{}).filter((t=>this.prices[t].product===e.price.product.id)).length>1?`${null===(n=null===(t=null==e?void 0:e.price)||void 0===t?void 0:t.product)||void 0===n?void 0:n.name} â€“ ${null===(i=null==e?void 0:e.price)||void 0===i?void 0:i.name}`:null===(r=null===(o=null==e?void 0:e.price)||void 0===o?void 0:o.product)||void 0===r?void 0:r.name,s}getRequestObject(e){var t;const n=((null===(t=null==e?void 0:e.line_items)||void 0===t?void 0:t.data)||[]).map((e=>({label:this.getName(e),amount:null!==e.ad_hoc_amount?e.ad_hoc_amount:e.price.amount})));return{currency:this.currencyCode,total:{amount:(null==e?void 0:e.amount_due)||0,label:(0,r._)("Total","surecart"),pending:!0},displayItems:n}}componentDidLoad(){if(!this.elements)return;const e=this.elements.create("paymentRequestButton",{paymentRequest:this.paymentRequest,style:{paymentRequestButton:{theme:this.theme}}});this.paymentRequest.on("paymentmethod",(e=>this.handlePaymentMethod(e))),this.paymentRequest.on("shippingaddresschange",(async e=>await this.handleShippingChange(e))),this.paymentRequest.canMakePayment().then((t=>{t?(e.mount(this.request),this.loaded=!0):"https:"!==location.protocol?(this.debug&&(this.debugError=(0,r._)("You must serve this page over HTTPS to display express payment buttons.","surecart")),console.log("SSL needed to display payment buttons.")):(this.debug&&(this.debugError=(0,r._)("You do not have any wallets set up in your browser.","surecart")),console.log("No wallets available."))})).catch((e=>{console.error(e)}))}async handlePaymentMethod(e){var t,n,i,o,r;const{billing_details:s}=null==e?void 0:e.paymentMethod,{shippingAddress:d}=e;this.scSetState.emit("FETCH");try{await(0,a.c)({id:null===(t=this.order)||void 0===t?void 0:t.id,data:{email:null==s?void 0:s.email,name:null==s?void 0:s.name,shipping_address:{...(null==d?void 0:d.name)?{name:null==d?void 0:d.name}:{},...(null===(n=null==d?void 0:d.addressLine)||void 0===n?void 0:n[0])?{line_1:null===(i=null==d?void 0:d.addressLine)||void 0===i?void 0:i[0]}:{},...(null===(o=null==d?void 0:d.addressLine)||void 0===o?void 0:o[1])?{line_2:null===(r=null==d?void 0:d.addressLine)||void 0===r?void 0:r[1]}:{},...(null==d?void 0:d.city)?{city:null==d?void 0:d.city}:{},...(null==d?void 0:d.country)?{country:null==d?void 0:d.country}:{},...(null==d?void 0:d.postalCode)?{postal_code:null==d?void 0:d.postalCode}:{},...(null==d?void 0:d.region)?{state:null==d?void 0:d.region}:{}}}});const l=await(0,a.f)({id:this.order.id,processor:"stripe",query:{form_id:this.formId}});await this.confirmPayment(l,e),console.log("paid"),this.scPaid.emit(),console.log("complete"),e.complete("success")}catch(t){console.error(t),this.scPayError.emit(t),e.complete("fail")}finally{this.confirming=!1}}async confirmPayment(e,t){var n,i,o,r,s,a,d,l,u,c,p,h,v,m,y,f,g,_;if("finalized"!==(null==e?void 0:e.status))return;if(!(null===(o=null===(i=null===(n=null==e?void 0:e.payment_intent)||void 0===n?void 0:n.processor_data)||void 0===i?void 0:i.stripe)||void 0===o?void 0:o.client_secret))return;if(!(null===(a=null===(s=null===(r=null==e?void 0:e.payment_intent)||void 0===r?void 0:r.processor_data)||void 0===s?void 0:s.stripe)||void 0===a?void 0:a.type))return;if(!(null===(d=null==e?void 0:e.payment_intent)||void 0===d?void 0:d.external_intent_id))return;if(this.confirming)return;let b;if(this.confirming=!0,b="setup"==(null===(c=null===(u=null===(l=null==e?void 0:e.payment_intent)||void 0===l?void 0:l.processor_data)||void 0===u?void 0:u.stripe)||void 0===c?void 0:c.type)?await this.confirmCardSetup(null===(h=null===(p=null==e?void 0:e.payment_intent)||void 0===p?void 0:p.processor_data)||void 0===h?void 0:h.stripe.client_secret,t):await this.confirmCardPayment(null===(m=null===(v=null==e?void 0:e.payment_intent)||void 0===v?void 0:v.processor_data)||void 0===m?void 0:m.stripe.client_secret,t),null==b?void 0:b.error)throw b.error;if("requires_action"===(null===(y=null==b?void 0:b.paymentIntent)||void 0===y?void 0:y.status)||"requires_source_action"===(null===(f=null==b?void 0:b.paymentIntent)||void 0===f?void 0:f.status)){const t=await this.stripe.confirmCardPayment(null===(_=null===(g=null==e?void 0:e.payment_intent)||void 0===g?void 0:g.processor_data)||void 0===_?void 0:_.stripe.client_secret);if(t.error)throw t.error;return t}return b}confirmCardPayment(e,t){return this.stripe.confirmCardPayment(e,{payment_method:t.paymentMethod.id},{handleActions:!1})}confirmCardSetup(e,t){return this.stripe.confirmCardSetup(e,{payment_method:t.paymentMethod.id},{handleActions:!1})}render(){return(0,i.h)("div",{class:{request:!0,"request--loaded":this.loaded}},this.debug&&this.debugError&&(0,i.h)("div",null,(0,i.h)("slot",{name:"debug-fallback"}),(0,i.h)("sc-alert",{type:"info",open:!0},(0,i.h)("span",{slot:"title"},(0,r._)("Express Payment","surecart")),this.debugError)),(0,i.h)("div",{class:"sc-payment-request-button",part:"button",ref:e=>this.request=e}))}get el(){return(0,i.g)(this)}static get watchers(){return{order:["handleOrderChange"],loaded:["handleLoaded"],error:["handleErrorChange"]}}};(0,s.o)(d,["currencyCode","country","prices","paymentMethod"],!1),d.style=":host{display:block}.or{display:none;margin:var(--sc-form-section-spacing) 0}.request--loaded .or{display:block}"}}]);
name: PHP 7.4 Compatibility Check

on:
  push:
    branches: [ master, dev, develop ]
    paths:
      - '**.php'
      - 'composer.json'
      - 'phpcs.xml'
      - '.github/workflows/php-compatibility.yml'
  pull_request:
    branches: [ master, dev, develop ]
    paths:
      - '**.php'
      - 'composer.json'
      - 'phpcs.xml'
      - '.github/workflows/php-compatibility.yml'

jobs:
  php-compatibility:
    runs-on: ubuntu-latest
    name: PHP 7.4 Compatibility Check

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        tools: composer
        coverage: none

    - name: Get Composer cache directory
      id: composer-cache
      run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

    - name: Cache Composer dependencies
      uses: actions/cache@v3
      with:
        path: ${{ steps.composer-cache.outputs.dir }}
        key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: ${{ runner.os }}-composer-

    - name: Install dependencies
      run: composer install --no-progress --no-ansi --prefer-dist

    - name: Run PHP 7.4 Compatibility Check
      run: |
        echo "::group::PHP Compatibility Analysis"
        vendor/bin/phpcs \
          --standard=PHPCompatibilityWP \
          --runtime-set testVersion 7.4- \
          --ignore=*/vendor/*,*/node_modules/*,*/lib/*,*/tests/*,*/build/* \
          --extensions=php \
          --colors \
          --report=full \
          --report-file=php-compatibility-report.txt \
          .
        echo "::endgroup::"

    - name: Display compatibility report
      if: failure()
      run: |
        echo "::error::PHP 7.4 Compatibility Issues Found"
        echo "Please review the following issues:"
        cat php-compatibility-report.txt || echo "No detailed report available"

    - name: Upload compatibility report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: php-compatibility-report
        path: php-compatibility-report.txt
        retention-days: 30

  specific-syntax-check:
    runs-on: ubuntu-latest
    name: Check for PHP 8+ Syntax

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check for Union Types
      run: |
        echo "::group::Checking for Union Types (PHP 8.0+)"
        if grep -r --include="*.php" -n '\w\+|\w\+.*\$' . --exclude-dir=vendor --exclude-dir=node_modules --exclude-dir=lib --exclude-dir=tests; then
          echo "::error::Union types found! These are not compatible with PHP 7.4"
          exit 1
        else
          echo "✅ No union types found"
        fi
        echo "::endgroup::"

    - name: Check for Match Expressions
      run: |
        echo "::group::Checking for Match Expressions (PHP 8.0+)"
        if grep -r --include="*.php" -n '^\s*match\s*(' . --exclude-dir=vendor --exclude-dir=node_modules --exclude-dir=lib --exclude-dir=tests; then
          echo "::error::Match expressions found! These are not compatible with PHP 7.4"
          exit 1
        else
          echo "✅ No match expressions found"
        fi
        echo "::endgroup::"

    - name: Check for Constructor Property Promotion
      run: |
        echo "::group::Checking for Constructor Property Promotion (PHP 8.0+)"
        if grep -r --include="*.php" -n 'public\s\+function\s\+__construct\s*(\s*\(public\|protected\|private\)' . --exclude-dir=vendor --exclude-dir=node_modules --exclude-dir=lib --exclude-dir=tests; then
          echo "::error::Constructor property promotion found! This is not compatible with PHP 7.4"
          exit 1
        else
          echo "✅ No constructor property promotion found"
        fi
        echo "::endgroup::"

    - name: Check for Mixed Type
      run: |
        echo "::group::Checking for Mixed Type (PHP 8.0+)"
        if grep -r --include="*.php" -n ':\s*mixed' . --exclude-dir=vendor --exclude-dir=node_modules --exclude-dir=lib --exclude-dir=tests; then
          echo "::error::Mixed type declarations found! These are not compatible with PHP 7.4"
          exit 1
        else
          echo "✅ No mixed type declarations found"
        fi
        echo "::endgroup::"

    - name: Check for Named Arguments Usage
      run: |
        echo "::group::Checking for Named Arguments (PHP 8.0+)"
        if grep -r --include="*.php" -n '\w\+:\s*\$' . --exclude-dir=vendor --exclude-dir=node_modules --exclude-dir=lib --exclude-dir=tests; then
          echo "::warning::Named arguments usage detected. Please verify these are in comments/docs only"
        else
          echo "✅ No named arguments usage found"
        fi
        echo "::endgroup::"

  summary:
    runs-on: ubuntu-latest
    needs: [php-compatibility, specific-syntax-check]
    if: always()
    steps:
    - name: Compatibility Summary
      run: |
        echo "## PHP 7.4 Compatibility Check Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.php-compatibility.result }}" == "success" ]; then
          echo "| PHPCompatibilityWP | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| PHPCompatibilityWP | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.specific-syntax-check.result }}" == "success" ]; then
          echo "| Syntax Check | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Syntax Check | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### What this checks:" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Union types (PHP 8.0+)" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Match expressions (PHP 8.0+)" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Constructor property promotion (PHP 8.0+)" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Mixed type declarations (PHP 8.0+)" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Overall PHP 7.4+ compatibility via PHPCompatibilityWP" >> $GITHUB_STEP_SUMMARY
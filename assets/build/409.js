/*! For license information please see 409.js.LICENSE.txt */
"use strict";(self.webpackChunksureforms=self.webpackChunksureforms||[]).push([[409],{5358:function(t,e,r){r.d(e,{F:function(){return i},p:function(){return n},r:function(){return o}});class i{constructor(t,e){this.form=null,this.input=t,this.options={form:t=>{var e,r;return(null===(r=null===(e=this.closestElement("sc-form",t))||void 0===e?void 0:e.shadowRoot)||void 0===r?void 0:r.querySelector("form"))||this.closestElement("form",t)},name:t=>t.name,value:t=>t.value,disabled:t=>t.disabled,...e},this.form=this.options.form(this.input),this.handleFormData=this.handleFormData.bind(this)}closestElement(t,e){return e?e&&e!=document&&e!=window&&e.closest(t)||this.closestElement(t,e.getRootNode().host):null}addFormData(){this.form&&this.form.addEventListener("formdata",this.handleFormData)}removeFormData(){this.form&&this.form.removeEventListener("formdata",this.handleFormData)}handleFormData(t){const e=this.options.disabled(this.input),r=this.options.name(this.input),i=this.options.value(this.input);e||"string"!=typeof r||void 0===i||(Array.isArray(i)?i.forEach((e=>{e&&t.formData.append(r,e.toString())})):i&&t.formData.append(r,i.toString()))}}const n=t=>{var e;const{email:r,name:i,password:n,shipping_city:o,shipping_country:s,shipping_line_1:a,shipping_line_2:d,shipping_postal_code:l,shipping_state:c,billing_city:u,billing_country:h,billing_line_1:p,billing_line_2:m,billing_postal_code:f,billing_state:v,"tax_identifier.number_type":g,"tax_identifier.number":y,...S}=t;console.log({data:t});const _={...o?{city:o}:{},...s?{country:s}:{},...a?{line_1:a}:{},...d?{line_2:d}:{},...l?{postal_code:l}:{},...c?{state:c}:{}},E={...u?{city:u}:{},...h?{country:h}:{},...p?{line_1:p}:{},...m?{line_2:m}:{},...f?{postal_code:f}:{},...v?{state:v}:{}};return{...i?{name:i}:{},...r?{email:r}:{},...n?{password:n}:{},...Object.keys(_||{}).length?{shipping_address:_}:{},...Object.keys(E||{}).length?{billing_address:E}:{},...g&&y?{tax_identifier:{number:y,number_type:g}}:{},...(null===(e=Object.keys(S))||void 0===e?void 0:e.length)?{metadata:S}:{}}},o=async t=>{const e=[...t.shadowRoot.querySelectorAll("*")].filter((t=>"function"==typeof t.reportValidity));for(const t of e)if(!await t.reportValidity())return!1;return!0}},4920:function(t,e,r){r.d(e,{c:function(){return d},e:function(){return s},f:function(){return l}});var i=r(712),n=r(8517);const o="surecart/v1/orders/",s=["line_items","line_item.price","price.product","customer","customer.shipping_address","payment_intent","discount","discount.promotion","discount.coupon","shipping_address","tax_identifier"],a=(t,e="")=>{let r=t?`${o}${t}`:o;return r=`${r}${e}`,(0,n.a)(r,{expand:s})},d=async({id:t,data:e,query:r={}})=>await(0,i.a)({method:t?"PATCH":"POST",path:(0,n.a)(a(t),r),data:e}),l=async({id:t,data:e={},query:r={},processor:o})=>await(0,i.a)({method:"POST",path:(0,n.a)(a(t,"/finalize/"),{processor_type:o,...r}),data:e})},409:function(t,e,r){r.r(e),r.d(e,{sc_form_components_validator:function(){return c},sc_form_error_provider:function(){return u},sc_form_state_provider:function(){return b},sc_order_confirm_provider:function(){return C},sc_order_redirect_provider:function(){return P},sc_session_provider:function(){return x}});var i=r(6046),n=r(290),o=r(712),s=r(4920),a=r(5358),d=r(8517);function l(t){const e=t.indexOf("?");if(-1===e)return t;const r=(0,d.g)(t),i=t.substr(0,e);for(var n=arguments.length,o=new Array(n>1?n-1:0),s=1;s<n;s++)o[s-1]=arguments[s];o.forEach((t=>delete r[t]));const a=(0,d.b)(r);return a?i+"?"+a:i}r(5115);const c=class{constructor(t){(0,i.r)(this,t)}handleOrderChange(){var t,e;this.disabled||("address_invalid"===(null===(t=null==this?void 0:this.order)||void 0===t?void 0:t.tax_status)||(null===(e=null==this?void 0:this.order)||void 0===e?void 0:e.shipping_enabled))&&this.addAddressField()}componentWillLoad(){this.hasAddress=!!this.el.querySelector("sc-order-shipping-address"),this.taxEnabled&&this.addAddressField()}addAddressField(){if(this.hasAddress)return;const t=this.el.querySelector("sc-payment"),e=document.createElement("sc-order-shipping-address");e.label=(0,n._)("Address","surecart"),t.parentNode.insertBefore(e,t),this.hasAddress=!0}render(){return(0,i.h)("slot",null)}get el(){return(0,i.g)(this)}static get watchers(){return{order:["handleOrderChange"]}}},u=class{constructor(t){(0,i.r)(this,t),this.scUpdateError=(0,i.c)(this,"scUpdateError",7),this.scSetState=(0,i.c)(this,"scSetState",7)}handleErrorUpdate(t){this.scUpdateError.emit(t)}handleOrderChange(){this.error=null}handleErrorEvent(t){this.error=t.detail,Object.keys((null==t?void 0:t.detail)||{}).length&&this.scSetState.emit("REJECT")}handlePayError(t){var e;this.error=(null===(e=t.detail)||void 0===e?void 0:e.message)||{code:"",message:"Something went wrong with your payment."}}getErrorMessage(t){return"order.line_items.price.blank"===t.code?(0,n._)("This product is no longer purchasable.","surecart"):null==t?void 0:t.message}errorMessage(){var t,e,r,i,n,o;return(null===(r=null===(e=null===(t=this.error)||void 0===t?void 0:t.additional_errors)||void 0===e?void 0:e[0])||void 0===r?void 0:r.message)?this.getErrorMessage(null===(n=null===(i=this.error)||void 0===i?void 0:i.additional_errors)||void 0===n?void 0:n[0]):(null===(o=null==this?void 0:this.error)||void 0===o?void 0:o.message)?this.getErrorMessage(null==this?void 0:this.error):""}render(){return(0,i.h)(i.H,null,!!this.errorMessage()&&(0,i.h)("sc-alert",{type:"danger",scrollOnOpen:!0,open:!!this.errorMessage()},(0,i.h)("span",{slot:"title"},this.errorMessage())),(0,i.h)("slot",null))}static get watchers(){return{error:["handleErrorUpdate"],order:["handleOrderChange"]}}};function h(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var i,n,o=r.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(i=o.next()).done;)s.push(i.value)}catch(t){n={error:t}}finally{try{i&&!i.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}return s}var p;!function(t){t[t.NotStarted=0]="NotStarted",t[t.Running=1]="Running",t[t.Stopped=2]="Stopped"}(p||(p={}));var m={type:"xstate.init"};function f(t){return void 0===t?[]:[].concat(t)}function v(t,e){return"string"==typeof(t="string"==typeof t&&e&&e[t]?e[t]:t)?{type:t}:"function"==typeof t?{type:t.name,exec:t}:t}function g(t){return function(e){return t===e}}function y(t){return"string"==typeof t?{type:t}:t}function S(t,e){return{value:t,context:e,actions:[],changed:!1,matches:g(t)}}function _(t,e,r){var i=e,n=!1;return[t.filter((function(t){if("xstate.assign"===t.type){n=!0;var e=Object.assign({},i);return"function"==typeof t.assignment?e=t.assignment(i,r):Object.keys(t.assignment).forEach((function(n){e[n]="function"==typeof t.assignment[n]?t.assignment[n](i,r):t.assignment[n]})),i=e,!1}return!0})),i,n]}var E=function(t,e){return t.actions.forEach((function(r){var i=r.exec;return i&&i(t.context,e)}))};const w=function(t,e){void 0===e&&(e={});var r=h(_(f(t.states[t.initial].entry).map((function(t){return v(t,e.actions)})),t.context,m),2),i=r[0],n=r[1],o={config:t,_options:e,initialState:{value:t.initial,actions:i,context:n,matches:g(t.initial)},transition:function(e,r){var i,n,s="string"==typeof e?{value:e,context:t.context}:e,a=s.value,d=s.context,l=y(r),c=t.states[a];if(c.on){var u=f(c.on[l.type]);try{for(var p=function(t){var e="function"==typeof Symbol&&Symbol.iterator,r=e&&t[e],i=0;if(r)return r.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&i>=t.length&&(t=void 0),{value:t&&t[i++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}(u),m=p.next();!m.done;m=p.next()){var E=m.value;if(void 0===E)return S(a,d);var w="string"==typeof E?{target:E}:E,b=w.target,C=w.actions,P=void 0===C?[]:C,O=w.cond,I=void 0===O?function(){return!0}:O,F=void 0===b,x=t.states[null!=b?b:a];if(I(d,l)){var R=h(_((F?f(P):[].concat(c.exit,P,x.entry).filter((function(t){return t}))).map((function(t){return v(t,o._options.actions)})),d,l),3),U=R[0],A=R[1],D=R[2],k=null!=b?b:a;return{value:k,context:A,actions:U,changed:b!==a||U.length>0||D,matches:g(k)}}}}catch(t){i={error:t}}finally{try{m&&!m.done&&(n=p.return)&&n.call(p)}finally{if(i)throw i.error}}}return S(a,d)}};return o}({id:"fetch",initial:"idle",context:{retries:3},states:{idle:{on:{FETCH:"loading"}},loading:{on:{RESOLVE:"draft",REJECT:"failure",EXPIRE:"expired",PAID:"paid"}},draft:{on:{FINALIZE:"finalizing",FETCH:"updating",REJECT:"draft"}},updating:{on:{RESOLVE:"draft",EXPIRE:"expired",REJECT:"draft"}},finalizing:{on:{PAID:"paid",REJECT:"draft"}},paid:{on:{CONFIRMED:"confirmed",REJECT:"draft"}},expired:{},confirmed:{},failure:{on:{RETRY:{target:"loading",actions:{type:"xstate.assign",assignment:{retries:t=>t.retries+1}}}}}}}),b=class{constructor(t){(0,i.r)(this,t),this.scSetCheckoutFormState=(0,i.c)(this,"scSetCheckoutFormState",7),this._stateService=function(t){var e=t.initialState,r=p.NotStarted,i=new Set,n={_machine:t,send:function(n){r===p.Running&&(e=t.transition(e,n),E(e,y(n)),i.forEach((function(t){return t(e)})))},subscribe:function(t){return i.add(t),t(e),{unsubscribe:function(){return i.delete(t)}}},start:function(i){if(i){var o="object"==typeof i?i:{context:t.config.context,value:i};e={value:o.value,actions:[],context:o.context,matches:g(o.value)}}return r=p.Running,E(e,m),n},stop:function(){return r=p.Stopped,i.clear(),n},get state(){return e},get status(){return r}};return n}(w),this.checkoutState=w.initialState}setState(t){const{send:e}=this._stateService;return e(t)}handleCheckoutStateChange(t){this.scSetCheckoutFormState.emit(t.value)}componentWillLoad(){this._stateService.subscribe((t=>this.checkoutState=t)),this._stateService.start()}disconnectedCallback(){this._stateService.stop()}handleSetStateEvent(t){this.setState(t.detail)}async handlePaid(){this.setState("PAID")}async handleConfirmed(){this.setState("CONFIRMED")}render(){return"expired"===this.checkoutState.value?(0,i.h)("sc-block-ui",null,(0,i.h)("div",null,(0,n._)("Please refresh the page.","surecart"))):(0,i.h)("slot",null)}static get watchers(){return{checkoutState:["handleCheckoutStateChange"]}}},C=class{constructor(t){(0,i.r)(this,t),this.scUpdateOrderState=(0,i.c)(this,"scUpdateOrderState",7),this.scConfirmed=(0,i.c)(this,"scConfirmed",7),this.scOrderPaid=(0,i.c)(this,"scOrderPaid",7),this.scError=(0,i.c)(this,"scError",7)}handlePaidEvent(){this.confirmOrder()}async confirmOrder(){var t;const e=await this.el.querySelector("sc-form").getFormJson();let r=(0,a.p)(e);try{const e=await(0,o.a)({method:"PATCH",path:(0,d.a)(`surecart/v1/orders/${null===(t=this.order)||void 0===t?void 0:t.id}/confirm`,[s.e]),data:r});this.scUpdateOrderState.emit(e),this.scConfirmed.emit(),this.scOrderPaid.emit(e)}catch(t){console.error(t),this.scError.emit(t)}}render(){return(0,i.h)("slot",null)}get el(){return(0,i.g)(this)}},P=class{constructor(t){(0,i.r)(this,t),this.scSetState=(0,i.c)(this,"scSetState",7),this.scError=(0,i.c)(this,"scError",7)}handleOrderPaid(){var t;if("paid"===(null===(t=this.order)||void 0===t?void 0:t.status))return this.scSetState.emit("PAID"),this.redirect()}componentDidLoad(){const t=(0,o.g)(window.location.href,"success_url");t&&(this.successUrl=t),this.handleOrderPaid()}redirect(){window.location.assign((0,d.a)(this.successUrl,{order:this.order.id}))}render(){return(0,i.h)("slot",null)}static get watchers(){return{order:["handleOrderPaid"]}}},O=(t,e,r)=>{if(null==e?void 0:e.id)return e.id;const i=(0,o.g)(window.location.href,"order");if(i)return i;const n=localStorage.getItem(`${t}-modified`);return n?r&&n===r?window.localStorage.getItem(t):"":window.localStorage.getItem(t)},I=t=>window.localStorage.removeItem(t),F=(t,e)=>{var r,i;const n=null===(i=null===(r=t.querySelector("sc-form"))||void 0===r?void 0:r.shadowRoot)||void 0===i?void 0:i.querySelector("slot");if(n)return n.assignedElements({flatten:!0}).reduce(((t,e)=>t.concat(e,[...e.querySelectorAll("*")])),[]).find((t=>t.name===e))},x=class{constructor(t){(0,i.r)(this,t),this.scUpdateOrderState=(0,i.c)(this,"scUpdateOrderState",7),this.scUpdateDraftState=(0,i.c)(this,"scUpdateDraftState",7),this.scError=(0,i.c)(this,"scError",7),this.scSetState=(0,i.c)(this,"scSetState",7),this.mode="live",this.prices=[],this.currencyCode="usd",this.processor="stripe"}handleSessionUpdate(t){this.scUpdateOrderState.emit(t)}handleOrderChange(t){var e,r,i,n,o;(null==t?void 0:t.id)&&(e=this.groupId,r=t.id,i=this.modified,window.localStorage.setItem(e,r),window.localStorage.setItem(`${e}-modified`,i)),"paid"===t.status&&I(this.groupId),n=this.el,o=t,["name","email"].forEach((t=>{const e=F(n,t);e&&o[t]&&(e.value=o[t])})),Object.keys((null==o?void 0:o.metadata)||{}).forEach((t=>{const e=F(n,t);e&&o.metadata[t]&&(e.value=o.metadata[t])}))}handleUpdateSession(t){const{data:e,options:r}=t.detail;(null==r?void 0:r.silent)?this.update({...this.defaultFormData(),...e}):this.loadUpdate(e)}handlePricesChange(){let t=this.addInitialPrices()||[];if(t=this.addPriceChoices(t),null==t?void 0:t.length)return this.loadUpdate({line_items:t})}async finalize(){return await this.handleFormSubmit()}getProcessor(){switch(this.processor){case"paypal":case"paypal-card":return"paypal";default:return"stripe"}}getPaymentIntent(){var t;const e=this.getProcessor();return null===(t=this.paymentIntents)||void 0===t?void 0:t[e]}async handleFormSubmit(){var t,e,r,i;this.scError.emit({});const n=this.getPaymentIntent();this.scSetState.emit("FINALIZE");const o=await this.el.querySelector("sc-form").getFormJson();let d=(0,a.p)(o);try{await this.update({...this.defaultFormData(),...d})}catch(t){console.error(t),this.scSetState.emit("REJECT"),this.handleErrorResponse(t)}if(this.session.total_amount>0&&!n&&"stripe"===this.getProcessor()&&this.stripePaymentElement)return this.scError.emit({message:"Something went wrong. Please try again."}),console.error("No payment intent found."),this.scSetState.emit("REJECT");try{const r=await(0,s.f)({id:this.order.id,data:d,query:{...this.defaultFormQuery(),...(null==n?void 0:n.id)?{payment_intent_id:null==n?void 0:n.id}:{}},processor:this.getProcessor()});return this.session.total_amount>0&&(null==n?void 0:n.id)&&(null===(t=null==r?void 0:r.payment_intent)||void 0===t?void 0:t.id)!==(null==n?void 0:n.id)?(console.error("Payment intent mismatch",null==n?void 0:n.id,null===(e=null==r?void 0:r.payment_intent)||void 0===e?void 0:e.id),this.scError.emit({message:"Something went wrong. Please try again."}),this.scSetState.emit("REJECT")):(this.session=r,this.session)}catch(t){if("order.line_items.old_price_versions"===(null===(i=null===(r=null==t?void 0:t.additional_errors)||void 0===r?void 0:r[0])||void 0===i?void 0:i.code))return void await this.loadUpdate({id:this.order.id,data:{status:"draft",refresh_price_versions:!0}});if(["order.invalid_status_transition"].includes(null==t?void 0:t.code))return await this.loadUpdate({id:this.order.id,data:{status:"draft"}}),void this.handleFormSubmit();this.handleErrorResponse(t)}}async handlePaid(){this.scSetState.emit("PAID")}async handlePayError(){this.scSetState.emit("REJECT")}async handleCouponApply(t){const e=t.detail;this.scError.emit({}),this.loadUpdate({discount:{...e?{promotion_code:e}:{}}})}handleErrorResponse(t){if("rest_cookie_invalid_nonce"!==(null==t?void 0:t.code)){if("readonly"===(null==t?void 0:t.code))return I(this.groupId),void window.location.assign(l(window.location.href,"order"));(null==t?void 0:t.message)&&this.scError.emit(t),"http_request_failed"===(null==t?void 0:t.code)&&this.scError.emit({message:"Something went wrong. Please reload the page and try again."}),this.scSetState.emit("REJECT")}else this.scSetState.emit("EXPIRE")}defaultFormData(){var t;return{return_url:window.top.location.href,currency:(null===(t=this.order)||void 0===t?void 0:t.currency)||this.currencyCode,live_mode:"test"!==this.mode,group_key:this.groupId}}defaultFormQuery(){return{form_id:this.formId}}componentDidLoad(){this.findOrCreateOrder()}findOrCreateOrder(){var t,e,r;const i=this.getInitialDataFromUrl();return(null===(t=null==i?void 0:i.discount)||void 0===t?void 0:t.promotion_code)&&window.history.replaceState({},document.title,l(window.location.href,"coupon")),(null===(e=null==i?void 0:i.line_items)||void 0===e?void 0:e.length)&&window.history.replaceState({},document.title,l(window.location.href,"line_items")),(null===(r=null==i?void 0:i.line_items)||void 0===r?void 0:r.length)||O(this.groupId,this.order,this.modified)&&this.persist?this.fetch(i):this.initialize(i)}getInitialDataFromUrl(){let t={};const e=((0,o.g)(window.location.href,"coupon")||"").toUpperCase();t={...t,...e?{discount:{promotion_code:e}}:{}};const r=(0,o.g)(window.location.href,"line_items");return t={...t,...r&&(null==r?void 0:r.length)?{line_items:r}:{}},t}async initialize(t={}){let e=this.addInitialPrices()||[];return e=this.addPriceChoices(e),(null==e?void 0:e.length)?this.loadUpdate({line_items:e,...t}):this.loadUpdate({...t})}addInitialPrices(){var t;return(null===(t=null==this?void 0:this.prices)||void 0===t?void 0:t.length)?this.prices.some((t=>!(null==t?void 0:t.id)))?void 0:this.prices.map((t=>({price_id:t.id,quantity:t.quantity}))):[]}addPriceChoices(t=[]){return this.el.querySelectorAll("[price-id]").forEach((e=>{e.checked&&t.push({quantity:e.quantity||1,price_id:e.priceId,...e.defaultAmount?{ad_hoc_amount:e.defaultAmount}:{}}),e.defaultAmount&&t.push({quantity:e.quantity||1,price_id:e.priceId,ad_hoc_amount:e.defaultAmount})})),t}getSessionId(){var t;if(null===(t=this.order)||void 0===t?void 0:t.id)return this.order.id;const e=O(this.groupId,this.order,this.modified);return this.persist?e:void 0}async fetch(t={}){this.loadUpdate({status:"draft",...t})}async update(t={},e={}){try{this.session=await(0,s.c)({id:this.getSessionId(),data:{...this.defaultFormData(),...t},query:{...this.defaultFormQuery(),...e}})}catch(t){if(["order.not_found"].includes(null==t?void 0:t.code))return I(this.groupId),this.initialize();throw console.error(t),t}}async loadUpdate(t={}){try{this.scSetState.emit("FETCH"),await this.update({...this.defaultFormData(),...t}),this.scSetState.emit("RESOLVE")}catch(t){this.handleErrorResponse(t)}}render(){return(0,i.h)("sc-line-items-provider",{order:this.order,onScUpdateLineItems:t=>this.loadUpdate({line_items:t.detail})},(0,i.h)("slot",null))}get el(){return(0,i.g)(this)}static get watchers(){return{session:["handleSessionUpdate"],order:["handleOrderChange"],prices:["handlePricesChange"]}}}}}]);
//# sourceMappingURL=409.js.map